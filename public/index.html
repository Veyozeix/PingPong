<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ping Pong</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">
  <script src="/socket.io/socket.io.js" defer></script>
  <style>
    :root{
      --bg:#061a12; --card:#10261b; --accent:#e7ff6e; --muted:#a0b38f;
      --btn:#21412f; --btn-hover:#29523c; --white:#e9f1e6; --border:#153b2a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--white);
      font-family:Nunito, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      display:flex; align-items:flex-start; justify-content:center; padding:24px;
      min-height:100vh;
    }
    body.game{ padding:0; }

    .layout{width:min(1220px,96vw); display:grid; gap:16px}
    .layout.lobby{grid-template-columns: 280px min(720px, 92vw) 260px;}
    .layout.onecol{
      grid-template-columns: min(720px, 92vw);
      width:100%;
      min-height:100vh;
      place-content:center;
      place-items:center;
    }
    @supports (min-height: 100dvh){
      .layout.onecol{ min-height:100dvh; }
    }

    h1{ text-align:center; font-size:64px; letter-spacing:6px; margin:0 0 20px; color:var(--accent); font-weight:800; }
    .card{
      background:var(--card); border-radius:14px; padding:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.25); border:1px solid var(--border);
    }
    .row{display:flex; gap:12px}
    input[type="text"]{
      flex:1; background:#081e15; border:2px solid #0f2a1f; outline:none;
      color:var(--white); padding:12px 14px; border-radius:8px; font-size:16px;
    }
    input::placeholder{color:#6c7a6e}
    button{
      background:var(--btn); border:none; color:var(--white); padding:12px 14px;
      border-radius:8px; font-weight:700; cursor:pointer;
      transition:transform .02s ease, background .2s ease; min-width:140px;
    }
    button:hover{background:var(--btn-hover)} button:active{transform:translateY(1px)}
    button[disabled]{opacity:.45; cursor:not-allowed}
    .muted{color:var(--muted); font-size:14px; margin-top:8px}
    .names{margin-top:8px; display:flex; gap:8px; flex-wrap:wrap}
    .pill{background:#0c2219; border:1px solid #183a2b; padding:6px 10px; border-radius:999px; font-size:13px}

    .chat{display:flex; flex-direction:column; height: 640px;}
    .chat h3{margin:6px 0 12px}
    .chat-log{
      flex:1; overflow:auto; background:#081e15; border:1px solid #0f2a1f; border-radius:10px; padding:10px;
      white-space: pre-wrap; word-break: break-word; overflow-wrap: anywhere; overflow-x: hidden;
    }
    .msg{margin:6px 0} .msg .n{font-weight:800; margin-right:6px} .msg.sys{color: var(--accent); font-weight:800}
    .chat-input{display:flex; gap:8px; margin-top:10px}

    .scoreboard h3{ margin:6px 0 12px; color:var(--accent); }
    .scoreboard .item{ display:flex; justify-content:space-between; padding:8px 10px; background:#0b1f17; border:1px solid #143425; border-radius:10px; margin-bottom:8px; }
    .scoreboard .empty{ color:var(--muted); font-style:italic; }

    #game .hud{display:flex; justify-content:space-between; align-items:center; margin:10px 0 16px}
    .score{font-size:18px}
    .canvas-wrap{display:grid; place-items:center}
    canvas{background:#04160f; border:2px solid #153b2a; border-radius:12px; width:640px; height:400px; max-width:92vw}

    .overlay{
      position:absolute; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(6,26,18,.75); border-radius:12px;
    }
    .overlay .inner{ text-align:center; padding:24px; max-width:90%; }
    .big-title{ font-size:64px; letter-spacing:6px; color:var(--accent); font-weight:800; margin-bottom:12px; }
    .overlay .actions{display:flex; gap:10px; justify-content:center; margin-top:12px}
    .overlay .timer{color:var(--muted); margin-top:6px}
  </style>
</head>
<body>
  <div id="layout" class="layout lobby">
    <div id="chatPanel" class="card chat">
      <h3>Lobbychatt</h3>
      <div id="chatLog" class="chat-log"></div>
      <div class="chat-input">
        <input id="chatText" type="text" placeholder="Skriv ett meddelande‚Ä¶" maxlength="500" />
        <button id="chatSend">Skicka</button>
      </div>
    </div>

    <div class="card">
      <h1>PING&nbsp;&nbsp;PONG</h1>

      <div id="lobby">
        <h2 style="text-align:left; margin:6px 0 14px">Spelk√∂</h2>
        <div class="row">
          <input id="name" type="text" placeholder="Skriv ditt namn" maxlength="18" />
          <button id="join">G√• med i k√∂n</button>
        </div>
        <div class="muted"><span id="count">0</span> spelare i k√∂n</div>
        <div id="names" class="names"></div>
        <div style="margin-top:10px">
          <button id="leave" style="display:none">L√§mna k√∂n</button>
        </div>
      </div>

      <div id="game" style="display:none; position:relative">
        <div class="hud">
          <div id="vs" style="font-weight:800"></div>
          <div class="score">B√§st av <span id="bestof">5</span> ‚Äî <span id="series">0 - 0</span></div>
          <button id="exit">L√§mna match</button>
        </div>
        <div class="canvas-wrap">
          <canvas id="c" width="640" height="400"></canvas>
        </div>
        <div class="muted" id="status"></div>

        <div id="overlay" class="overlay">
          <div class="inner">
            <div id="ovTitle" class="big-title">VINNARE VANN!!!</div>
            <div class="actions" id="ovActions"></div>
            <div class="timer" id="ovTimer"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="scoreWrap" class="card scoreboard">
      <h3>SCOREBOARD (24H)</h3>
      <div id="scoreList"></div>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const el = (id) => document.getElementById(id);

    const layout   = el('layout');
    const chatPanel= el('chatPanel');

    const lobby    = el('lobby');
    const game     = el('game');
    const exitBtn  = el('exit');
    const vsEl     = el('vs');
    const bestOfEl = el('bestof');
    const seriesEl = el('series');
    const statusEl = el('status');

    const nameInput = el('name');
    const joinBtn   = el('join');
    const leaveBtn  = el('leave');
    const countEl   = el('count');
    const namesEl   = el('names');

    const overlay  = el('overlay');
    const ovTitle  = el('ovTitle');
    const ovActions= el('ovActions');
    const ovTimer  = el('ovTimer');

    const chatLog  = el('chatLog');
    const chatText = el('chatText');
    const chatSend = el('chatSend');

    const scoreWrap= el('scoreWrap');
    const scoreList= el('scoreList');

    function updateJoin(){ joinBtn.disabled = nameInput.value.trim().length < 1; }
    nameInput.addEventListener('input', updateJoin); updateJoin();

    const socket = io();

    // --- Chat: state + cooldown ---
    let inQueue = false, chatCooldownTimer = null, chatCanSend = false;
    function setChatEnabled(enabled){ chatText.disabled=!enabled; chatSend.disabled=!enabled; }
    function startChatCooldown(seconds=5){
      chatCanSend=false; setChatEnabled(false);
      let t=seconds; const original='Skicka';
      chatSend.textContent=`V√§nta (${t})`;
      chatCooldownTimer=setInterval(()=>{ t--; chatSend.textContent=`V√§nta (${t})`;
        if(t<=0){ clearInterval(chatCooldownTimer); chatCooldownTimer=null;
          chatSend.textContent=original; if(inQueue){ setChatEnabled(true); chatCanSend=true; } }
      },1000);
    }
    setChatEnabled(false);

    // Scoreboard render
    function renderScoreboard(list){
      if(!Array.isArray(list)||list.length===0){
        scoreList.innerHTML = `<div class="empty">Ingen har vunnit en match de senaste 24 timmarna.</div>`;
        return;
      }
      scoreList.innerHTML = list.map(item =>
        `<div class="item"><span>${item.name}</span><span>${item.count} ${item.count===1?'Match':'Matcher'}</span></div>`
      ).join('');
    }

    // Canvas & spel-state
    const canvas = el('c'); const ctx = canvas.getContext('2d');
    let roomId=null, selfId=null, oppId=null, myName='', mySide='left';
    let padH=70, padW=10, ballSize=10, leftY=165, rightY=165, ballX=320, ballY=200;

    function appendMsg({name,text,ts}){ const d=document.createElement('div');
      d.className='msg'; const t=new Date(ts||Date.now()).toLocaleTimeString();
      d.innerHTML=`<span class="n">${name}</span><span class="t">${text}</span> <span class="muted" style="float:right">${t}</span>`;
      chatLog.appendChild(d); chatLog.scrollTop=chatLog.scrollHeight; }
    function appendSys(text){ const d=document.createElement('div'); d.className='msg sys'; d.textContent=text;
      chatLog.appendChild(d); chatLog.scrollTop=chatLog.scrollHeight; }

    chatSend.addEventListener('click', ()=>{
      const text=chatText.value.trim(); if(!text) return; if(!inQueue||!chatCanSend) return;
      socket.emit('chat:message',{text}); chatText.value=''; startChatCooldown(5);
    });
    chatText.addEventListener('keydown', e=>{ if(e.key==='Enter') chatSend.click(); });
    socket.on('chat:message', appendMsg);
    socket.on('chat:system',  appendSys);
    socket.on('chat:error', (msg)=>{ appendSys(msg);
      if(/V√§nta\s+\d+s/.test(msg)&&!chatCooldownTimer){
        const m=msg.match(/V√§nta\s+(\d+)s/); startChatCooldown(m?parseInt(m[1],10):5);
      } });

    function resetLobbyButtons(){
      nameInput.disabled=false; updateJoin(); leaveBtn.style.display='none';
      joinBtn.disabled = nameInput.value.trim().length < 1;
    }

    joinBtn.addEventListener('click', ()=>{
      const n=nameInput.value.trim(); if(!n) return; myName=n;
      socket.emit('queue:join', n); leaveBtn.style.display='inline-block'; joinBtn.disabled=true; nameInput.disabled=true;
    });
    leaveBtn.addEventListener('click', ()=>{ socket.emit('queue:leave'); });

    socket.on('queue:joined', ()=>{ inQueue=true; if(!chatCooldownTimer){ setChatEnabled(true); chatCanSend=true; } });
    socket.on('queue:left', ()=>{ inQueue=false; setChatEnabled(false); chatCanSend=false; resetLobbyButtons(); });

    socket.on('queue:update', ({count,names})=>{
      countEl.textContent=count;
      namesEl.innerHTML = names.map(n=>`<span class="pill">${n}</span>`).join('');
    });
    socket.on('score:update', renderScoreboard);

    // Ritning
    function draw(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.globalAlpha=.15; for(let y=10;y<canvas.height;y+=20){ ctx.fillStyle='#e7ff6e'; ctx.fillRect(canvas.width/2-2,y,4,10); }
      ctx.globalAlpha=1; ctx.fillStyle='#e9f1e6';
      ctx.fillRect(10, leftY, padW, padH);
      ctx.fillRect(canvas.width-20, rightY, padW, padH);
      ctx.fillRect(ballX-ballSize/2, ballY-ballSize/2, ballSize, ballSize);
    } draw();

    function toCanvasY(clientY){ const r=canvas.getBoundingClientRect(); return (clientY - r.top) * (canvas.height / r.height); }
    function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }

    function sendTarget(y){
      if(!roomId) return;
      const targetY=clamp(y - padH/2, 0, canvas.height - padH);
      socket.emit('input:move', { roomId, targetY });
    }

    // Styrning med mus
    canvas.addEventListener('mousemove', e=> sendTarget(toCanvasY(e.clientY)));

    // Styrning med piltangenter/W,S
    window.addEventListener('keydown', e=>{
      const step=14;
      const currentY = (mySide === 'left' ? leftY : rightY);
      if(e.key==='ArrowUp'||e.key==='w'){ sendTarget(currentY - step + padH/2); }
      if(e.key==='ArrowDown'||e.key==='s'){ sendTarget(currentY + step + padH/2); }
    });

    exitBtn?.addEventListener('click', ()=> window.location.reload());

    function setLobbyLayout(){
      document.body.classList.remove('game');
      layout.classList.add('lobby');
      layout.classList.remove('onecol');
      chatPanel.style.display='flex';
      scoreWrap.style.display='block';
    }
    function setGameLayout(){
      document.body.classList.add('game');
      layout.classList.remove('lobby');
      layout.classList.add('onecol');
      chatPanel.style.display='none';
      scoreWrap.style.display='none';
    }

    // üîß Viktigt: √•terst√§ll r, selfId, mySide n√§r matchen startar
    socket.on('match:start', ({ roomId: r, opponent, players, sides }) => {
      roomId = r;
      selfId = players.selfId;
      oppId  = players.oppId;
      mySide = (sides.leftId === selfId) ? 'left' : 'right';

      lobby.style.display='none';
      game.style.display='block';
      setGameLayout();

      const myDispName = nameInput.value.trim() || 'Du';
      vsEl.textContent = `${myDispName} vs ${opponent}`;
      seriesEl.textContent = '0 - 0';
      statusEl.textContent = '';
      hideOverlay();
    });

    socket.on('series:update', ({bestOf,rounds})=>{
      if(bestOf) bestOfEl.textContent=String(bestOf);
      if(!rounds||!selfId||!oppId) return;
      const myWins=rounds[selfId]||0, oppWins=rounds[oppId]||0;
      seriesEl.textContent = `${myWins} - ${oppWins}`;
    });

    socket.on('round:next', ()=>{ statusEl.textContent='Ny runda‚Ä¶'; setTimeout(()=>statusEl.textContent='',600); });

    // üîß Viktigt: ta med padH/padW/ballSize fr√•n servern
    socket.on('state:update', (s)=>{
      leftY=s.leftY; rightY=s.rightY; ballX=s.ballX; ballY=s.ballY;
      padH=s.padH; padW=s.padW; ballSize=s.ballSize;
      draw();
    });

    const overlayEl = overlay;
    let countdownInt=null;
    function showOverlay(){ overlayEl.style.display='flex'; }
    function hideOverlay(){ overlayEl.style.display='none'; ovTitle.textContent=''; ovActions.innerHTML=''; ovTimer.textContent='';
      if(countdownInt){ clearInterval(countdownInt); countdownInt=null; } }

    function backToLobby(){
      game.style.display='none';
      lobby.style.display='block';
      setLobbyLayout();
      roomId=null; // g√∂r att input inte l√§ngre skickas
      hideOverlay();
    }

    socket.on('match:end', ({ winnerId, loserId, winnerName }) => {
      ovTitle.textContent = `${winnerName || 'Spelare'} VANN!!!`;
      showOverlay();

      ovActions.innerHTML = '';
      ovTimer.textContent = '';

      const btn=document.createElement('button');
      btn.textContent='Tillbaka till k√∂n';
      btn.onclick=backToLobby;
      ovActions.appendChild(btn);

      let t=10; ovTimer.textContent=`Tillbaka till k√∂n om ${t} sekunder`;
      countdownInt=setInterval(()=>{ t--; ovTimer.textContent=`Tillbaka till k√∂n om ${t} sekunder`;
        if(t<=0){ clearInterval(countdownInt); countdownInt=null; backToLobby(); }
      },1000);
    });

    socket.on('match:opponent-left', ()=>{ appendSys('Motst√•ndaren l√§mnade matchen.'); backToLobby(); });
  });
  </script>
</body>
</html>
